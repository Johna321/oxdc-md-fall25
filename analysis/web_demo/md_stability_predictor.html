<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD Stability Predictor | Force Field Parameter Analysis</title>
    <style>
        :root {
            --stable: #2ecc71;
            --marginal: #f1c40f;
            --unstable: #e74c3c;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --text: #eee;
            --accent: #0f3460;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #3498db, #9b59b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #888;
            font-size: 1.1rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #fff;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 0.5rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
            color: #aaa;
        }

        .input-row {
            display: flex;
            gap: 1rem;
        }

        .input-row > div {
            flex: 1;
        }

        input[type="number"] {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid var(--accent);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: var(--text);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #3498db;
        }

        .bond-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .ligand-label {
            font-weight: bold;
            color: #3498db;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .result-display {
            text-align: center;
            padding: 2rem;
        }

        .stability-meter {
            width: 100%;
            height: 30px;
            background: linear-gradient(90deg, var(--stable), var(--marginal), var(--unstable));
            border-radius: 15px;
            position: relative;
            margin: 1rem 0;
        }

        .meter-marker {
            position: absolute;
            top: -5px;
            width: 10px;
            height: 40px;
            background: white;
            border-radius: 5px;
            transform: translateX(-50%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: left 0.5s ease;
        }

        .stability-score {
            font-size: 4rem;
            font-weight: bold;
            margin: 1rem 0;
        }

        .stability-label {
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .canvas-container {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        canvas {
            width: 100%;
            height: 300px;
            border-radius: 8px;
        }

        .reference-systems {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .ref-system {
            padding: 0.8rem;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .ref-system:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .ref-system.stable { background: rgba(46, 204, 113, 0.2); border: 2px solid var(--stable); }
        .ref-system.unstable { background: rgba(52, 152, 219, 0.2); border: 2px solid #3498db; }
        .ref-system.crashed { background: rgba(231, 76, 60, 0.2); border: 2px solid var(--unstable); }

        .ref-system .name { font-weight: bold; }
        .ref-system .status { font-size: 0.8rem; opacity: 0.8; }

        .info-box {
            background: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0 8px 8px 0;
        }

        .info-box h3 {
            color: #3498db;
            margin-bottom: 0.5rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .metric {
            background: rgba(255,255,255,0.05);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #3498db;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.3rem;
        }

        footer {
            text-align: center;
            margin-top: 2rem;
            color: #666;
            font-size: 0.9rem;
        }

        footer a {
            color: #3498db;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>MD Stability Predictor</h1>
            <p class="subtitle">Predict metalloenzyme MD simulation stability from force field parameters</p>
        </header>

        <div class="main-grid">
            <div class="card">
                <h2>Force Field Parameters</h2>
                <p style="color: #888; margin-bottom: 1rem; font-size: 0.9rem;">
                    Enter Mn-ligand force constants (k) and equilibrium distances (r₀) from MCPB.py
                </p>

                <div class="ligand-label">His #1 (e.g., His95)</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>r₀ (Å)</label>
                        <input type="number" id="r0_1" value="2.25" step="0.01" min="1.5" max="3.0" oninput="updatePrediction()">
                    </div>
                    <div class="input-group">
                        <label>k (kcal/mol·Å²)</label>
                        <input type="number" id="k_1" value="33" step="1" min="5" max="200" oninput="updatePrediction()">
                    </div>
                </div>

                <div class="ligand-label">His #2 (e.g., His97)</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>r₀ (Å)</label>
                        <input type="number" id="r0_2" value="2.19" step="0.01" min="1.5" max="3.0" oninput="updatePrediction()">
                    </div>
                    <div class="input-group">
                        <label>k (kcal/mol·Å²)</label>
                        <input type="number" id="k_2" value="46" step="1" min="5" max="200" oninput="updatePrediction()">
                    </div>
                </div>

                <div class="ligand-label">Glu/Asp</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>r₀ (Å)</label>
                        <input type="number" id="r0_3" value="2.11" step="0.01" min="1.5" max="3.0" oninput="updatePrediction()">
                    </div>
                    <div class="input-group">
                        <label>k (kcal/mol·Å²)</label>
                        <input type="number" id="k_3" value="36" step="1" min="5" max="200" oninput="updatePrediction()">
                    </div>
                </div>

                <div class="ligand-label">His #3 (e.g., His140)</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>r₀ (Å)</label>
                        <input type="number" id="r0_4" value="2.20" step="0.01" min="1.5" max="3.0" oninput="updatePrediction()">
                    </div>
                    <div class="input-group">
                        <label>k (kcal/mol·Å²)</label>
                        <input type="number" id="k_4" value="45" step="1" min="5" max="200" oninput="updatePrediction()">
                    </div>
                </div>

                <div class="info-box">
                    <h3>Quick Load Reference Systems</h3>
                    <div class="reference-systems">
                        <div class="ref-system stable" onclick="loadSystem('BiOx+2')">
                            <div class="name">BiOx+2</div>
                            <div class="status">STABLE</div>
                        </div>
                        <div class="ref-system unstable" onclick="loadSystem('1Wat+2')">
                            <div class="name">1Wat+2</div>
                            <div class="status">UNSTABLE</div>
                        </div>
                        <div class="ref-system unstable" onclick="loadSystem('1Wat+3')">
                            <div class="name">1Wat+3</div>
                            <div class="status">UNSTABLE</div>
                        </div>
                        <div class="ref-system crashed" onclick="loadSystem('empty+2')">
                            <div class="name">empty+2</div>
                            <div class="status">CRASHED</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Stability Prediction</h2>

                <div class="result-display">
                    <div class="stability-meter">
                        <div class="meter-marker" id="marker"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #888;">
                        <span>STABLE</span>
                        <span>MARGINAL</span>
                        <span>UNSTABLE</span>
                    </div>

                    <div class="stability-score" id="score">--</div>
                    <div class="stability-label" id="label">Enter parameters</div>
                </div>

                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-value" id="avg-k">--</div>
                        <div class="metric-label">Avg Force Constant</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="avg-r0">--</div>
                        <div class="metric-label">Avg Bond Length</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="k-range">--</div>
                        <div class="metric-label">k Range</div>
                    </div>
                </div>

                <div class="canvas-container">
                    <canvas id="chart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>How It Works</h2>
            <p style="line-height: 1.6;">
                This tool predicts MD simulation stability based on force field parameters derived from
                <strong>MCPB.py</strong> (Metal Center Parameter Builder). The prediction model is based on
                empirical analysis of oxalate decarboxylase (OxDC) simulations across multiple system variants.
            </p>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                <div style="background: rgba(46, 204, 113, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--stable);">
                    <strong style="color: var(--stable);">STABLE (k &lt; 35)</strong>
                    <p style="font-size: 0.85rem; margin-top: 0.5rem;">Lower force constants allow thermal fluctuations without energy spikes</p>
                </div>
                <div style="background: rgba(241, 196, 15, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--marginal);">
                    <strong style="color: var(--marginal);">MARGINAL (35-60)</strong>
                    <p style="font-size: 0.85rem; margin-top: 0.5rem;">May require careful equilibration and longer minimization</p>
                </div>
                <div style="background: rgba(231, 76, 60, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--unstable);">
                    <strong style="color: var(--unstable);">UNSTABLE (k &gt; 60)</strong>
                    <p style="font-size: 0.85rem; margin-top: 0.5rem;">High risk of vlimit errors, SHAKE failures, or trajectory crashes</p>
                </div>
            </div>
        </div>

        <footer>
            <p>Based on research from OxDC MD simulations |
               <a href="https://pubs.acs.org/doi/10.1021/ct400055v" target="_blank">Literature: JCTC Mn Parameters</a>
            </p>
        </footer>
    </div>

    <script>
        // Reference systems data
        const refSystems = {
            'BiOx+2': {
                r0: [2.406, 2.259, 2.084, 2.249],
                k: [14.0, 31.7, 38.7, 32.9],
                status: 'STABLE',
                stability: 29
            },
            '1Wat+2': {
                r0: [2.249, 2.189, 2.108, 2.196],
                k: [33.0, 46.0, 36.5, 45.3],
                status: 'UNSTABLE',
                stability: 1254
            },
            '1Wat+3': {
                r0: [2.019, 2.030, 1.862, 2.033],
                k: [92.8, 85.1, 125.3, 85.9],
                status: 'UNSTABLE',
                stability: 446
            },
            'empty+2': {
                r0: [2.162, 2.197, 2.153, 2.161],
                k: [52.9, 43.3, 27.1, 52.6],
                status: 'CRASHED',
                stability: 3726
            }
        };

        function loadSystem(name) {
            const sys = refSystems[name];
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`r0_${i}`).value = sys.r0[i-1];
                document.getElementById(`k_${i}`).value = sys.k[i-1];
            }
            updatePrediction();
        }

        function calculateStabilityScore(k_values, r0_values) {
            const avgK = k_values.reduce((a,b) => a+b, 0) / k_values.length;
            const avgR0 = r0_values.reduce((a,b) => a+b, 0) / r0_values.length;
            const kRange = Math.max(...k_values) - Math.min(...k_values);

            // Empirical stability formula
            // Lower avgK = more stable, longer avgR0 = more stable, lower kRange = more stable
            let score = 100 - (avgK - 25) * 1.5 - (2.2 - avgR0) * 50 - kRange * 0.3;
            score = Math.max(0, Math.min(100, score));

            return {
                score: score,
                avgK: avgK,
                avgR0: avgR0,
                kRange: kRange
            };
        }

        function getStatusFromScore(score) {
            if (score >= 70) return { label: 'STABLE', color: '#2ecc71' };
            if (score >= 40) return { label: 'MARGINAL', color: '#f1c40f' };
            return { label: 'UNSTABLE', color: '#e74c3c' };
        }

        function updatePrediction() {
            const k_values = [];
            const r0_values = [];

            for (let i = 1; i <= 4; i++) {
                k_values.push(parseFloat(document.getElementById(`k_${i}`).value) || 0);
                r0_values.push(parseFloat(document.getElementById(`r0_${i}`).value) || 0);
            }

            const result = calculateStabilityScore(k_values, r0_values);
            const status = getStatusFromScore(result.score);

            // Update display
            document.getElementById('score').textContent = Math.round(result.score);
            document.getElementById('score').style.color = status.color;
            document.getElementById('label').textContent = status.label;
            document.getElementById('label').style.color = status.color;

            // Update meter marker
            const marker = document.getElementById('marker');
            marker.style.left = `${100 - result.score}%`;

            // Update metrics
            document.getElementById('avg-k').textContent = result.avgK.toFixed(1);
            document.getElementById('avg-r0').textContent = result.avgR0.toFixed(3);
            document.getElementById('k-range').textContent = result.kRange.toFixed(1);

            // Update chart
            drawChart(result.avgK, result.avgR0, k_values, r0_values);
        }

        function drawChart(avgK, avgR0, k_values, r0_values) {
            const canvas = document.getElementById('chart');
            const ctx = canvas.getContext('2d');

            // Set actual pixel dimensions
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = 600;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Chart dimensions
            const padding = 80;
            const width = canvas.width - 2 * padding;
            const height = canvas.height - 2 * padding;

            // Scales
            const kMin = 10, kMax = 140;
            const r0Min = 1.8, r0Max = 2.5;

            const xScale = (r0) => padding + (r0 - r0Min) / (r0Max - r0Min) * width;
            const yScale = (k) => padding + height - (k - kMin) / (kMax - kMin) * height;

            // Draw stability zones
            ctx.globalAlpha = 0.2;

            // Stable zone (k < 35)
            ctx.fillStyle = '#2ecc71';
            ctx.fillRect(padding, yScale(35), width, height - (height - (yScale(35) - padding)));

            // Marginal zone (35 < k < 60)
            ctx.fillStyle = '#f1c40f';
            ctx.fillRect(padding, yScale(60), width, yScale(35) - yScale(60));

            // Unstable zone (k > 60)
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(padding, padding, width, yScale(60) - padding);

            ctx.globalAlpha = 1;

            // Draw axes
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, padding + height);
            ctx.lineTo(padding + width, padding + height);
            ctx.stroke();

            // Axis labels
            ctx.fillStyle = '#aaa';
            ctx.font = '24px system-ui';
            ctx.textAlign = 'center';
            ctx.fillText('Equilibrium Distance r₀ (Å)', padding + width/2, canvas.height - 20);

            ctx.save();
            ctx.translate(25, padding + height/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillText('Force Constant k (kcal/mol·Å²)', 0, 0);
            ctx.restore();

            // Tick marks
            ctx.font = '20px system-ui';
            for (let r0 = 1.8; r0 <= 2.5; r0 += 0.1) {
                const x = xScale(r0);
                ctx.fillText(r0.toFixed(1), x, padding + height + 30);
            }
            for (let k = 20; k <= 140; k += 20) {
                const y = yScale(k);
                ctx.fillText(k.toString(), padding - 40, y + 5);
            }

            // Draw reference systems
            const refColors = {
                'BiOx+2': '#2ecc71',
                '1Wat+2': '#3498db',
                '1Wat+3': '#9b59b6',
                'empty+2': '#e74c3c'
            };

            ctx.font = '18px system-ui';
            for (const [name, sys] of Object.entries(refSystems)) {
                const sysAvgK = sys.k.reduce((a,b) => a+b, 0) / 4;
                const sysAvgR0 = sys.r0.reduce((a,b) => a+b, 0) / 4;

                ctx.fillStyle = refColors[name];
                ctx.beginPath();
                ctx.arc(xScale(sysAvgR0), yScale(sysAvgK), 15, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#fff';
                ctx.fillText(name, xScale(sysAvgR0) + 20, yScale(sysAvgK) - 15);
            }

            // Draw current point
            ctx.fillStyle = '#fff';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(xScale(avgR0), yScale(avgK), 20, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            ctx.fillStyle = '#000';
            ctx.font = 'bold 16px system-ui';
            ctx.fillText('YOU', xScale(avgR0), yScale(avgK) + 5);

            // Zone labels
            ctx.fillStyle = '#2ecc71';
            ctx.font = 'bold 24px system-ui';
            ctx.fillText('STABLE ZONE', padding + width - 150, yScale(25));

            ctx.fillStyle = '#f1c40f';
            ctx.fillText('MARGINAL', padding + width - 120, yScale(47));

            ctx.fillStyle = '#e74c3c';
            ctx.fillText('UNSTABLE', padding + width - 120, yScale(100));
        }

        // Initial update
        updatePrediction();

        // Resize handler
        window.addEventListener('resize', updatePrediction);
    </script>
</body>
</html>
